<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MapleQuest RPG - Integration Test</title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        body {
            background: #1a1a2e;
            color: #fff;
        }
        .test-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 400px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #44ff66;
            border-radius: 10px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 90vh;
            overflow-y: auto;
            z-index: 10000;
        }
        .test-panel h2 {
            margin: 0 0 10px 0;
            color: #44ff66;
            font-size: 16px;
        }
        .test-button {
            background: #44ff66;
            color: #000;
            border: none;
            padding: 8px 15px;
            margin: 5px 5px 5px 0;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
        }
        .test-button:hover {
            background: #66ffaa;
        }
        .test-button:active {
            transform: scale(0.95);
        }
        .test-log {
            background: #000;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
            font-size: 11px;
            line-height: 1.4;
        }
        .test-log div {
            padding: 2px 0;
            border-bottom: 1px solid #333;
        }
        .test-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
            background: #2a2a3e;
        }
        .status-pass { color: #44ff66; }
        .status-fail { color: #ff4444; }
        .status-warn { color: #ffaa44; }
        .status-running { color: #44aaff; }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas" width="1000" height="600"></canvas>

        <div class="job-select" id="jobSelect">
            <h1>ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”</h1>
            <p>ê° ì§ì—…ì€ ê³ ìœ í•œ ìŠ¤íƒ¯ê³¼ ìŠ¤í‚¬ì„ ê°€ì§€ê³  ìˆìŠµë‹ˆë‹¤</p>
            <div class="job-cards">
                <div class="job-card warrior" data-job="warrior">
                    <h2 style="color: #ff6644">ì „ì‚¬</h2>
                    <div class="job-icon">âš”ï¸</div>
                    <div class="job-stats">
                        <div>â¤ï¸ HP: â˜…â˜…â˜…â˜…â˜…</div>
                        <div>âš¡ ì†ë„: â˜…â˜…â˜†â˜†â˜†</div>
                        <div>ğŸ’ª ê³µê²©ë ¥: â˜…â˜…â˜…â˜…â˜†</div>
                        <div style="color: #ff6644; margin-top: 10px;">
                            <b>ìŠ¤í‚¬:</b><br>
                            [A] ê¸°ë³¸ê³µê²© - ê²€ íœ˜ë‘ë¥´ê¸°<br>
                            [Z] ğŸ’¥ íŒŒì›Œ ìŠ¤íŠ¸ë¼ì´í¬<br>
                            [X] ğŸŒ€ ìŠ¬ë˜ì‹œ ë¸”ë˜ìŠ¤íŠ¸<br>
                            [C] ğŸ˜¤ ë ˆì´ì§€ (ë²„í”„)
                        </div>
                    </div>
                </div>
                <div class="job-card thief" data-job="thief">
                    <h2 style="color: #aa44ff">ë„ì </h2>
                    <div class="job-icon">ğŸ—¡ï¸</div>
                    <div class="job-stats">
                        <div>â¤ï¸ HP: â˜…â˜…â˜…â˜†â˜†</div>
                        <div>âš¡ ì†ë„: â˜…â˜…â˜…â˜…â˜…</div>
                        <div>ğŸ’ª ê³µê²©ë ¥: â˜…â˜…â˜…â˜†â˜†</div>
                        <div style="color: #aa44ff; margin-top: 10px;">
                            <b>ìŠ¤í‚¬:</b><br>
                            [A] ê¸°ë³¸ê³µê²© - ë‹¨ê²€ ë‚œë¬´<br>
                            [Z] âš¡ ì‚¼ì¤‘ ìŠ¤íƒ­<br>
                            [X] ğŸ’€ ì–´ìŒ”ì‹œë„¤ì´íŠ¸<br>
                            [C] ğŸ’¨ í—¤ì´ìŠ¤íŠ¸ (ë²„í”„)
                        </div>
                    </div>
                </div>
                <div class="job-card archer" data-job="archer">
                    <h2 style="color: #44ff66">ê¶ìˆ˜</h2>
                    <div class="job-icon">ğŸ¹</div>
                    <div class="job-stats">
                        <div>â¤ï¸ HP: â˜…â˜…â˜†â˜†â˜†</div>
                        <div>âš¡ ì†ë„: â˜…â˜…â˜…â˜†â˜†</div>
                        <div>ğŸ’ª ê³µê²©ë ¥: â˜…â˜…â˜…â˜…â˜…</div>
                        <div style="color: #44ff66; margin-top: 10px;">
                            <b>ìŠ¤í‚¬:</b><br>
                            [A] ê¸°ë³¸ê³µê²© - í™”ì‚´ ë°œì‚¬<br>
                            [Z] â¹ ë”ë¸” ìƒ·<br>
                            [X] ğŸŒ§ï¸ ì• ë¡œìš° ë ˆì¸<br>
                            [C] âœ¨ ì†Œìš¸ ì• ë¡œìš° (ë²„í”„)
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="ui-overlay" id="gameUI" style="display: none;">
            <div><span id="jobIcon">âš”ï¸</span> Lv. <span id="level">1</span> <span id="jobName">ì „ì‚¬</span></div>
            <div class="stat-bar"><div class="hp-fill" id="hpBar" style="width: 100%"></div></div>
            <div style="font-size: 12px">HP: <span id="hpText">100/100</span></div>
            <div class="stat-bar"><div class="mp-fill" id="mpBar" style="width: 100%"></div></div>
            <div style="font-size: 12px">MP: <span id="mpText">50/50</span></div>
            <div class="stat-bar"><div class="exp-fill" id="expBar" style="width: 0%"></div></div>
            <div style="font-size: 12px">EXP: <span id="expText">0/100</span></div>
            <div style="margin-top: 10px">âš”ï¸ ê³µê²©ë ¥: <span id="attack">10</span></div>
            <div>ğŸ’¥ í¬ë¦¬í‹°ì»¬: <span id="crit">10</span>%</div>
            <div>ğŸ’€ ì²˜ì¹˜: <span id="kills">0</span></div>
        </div>

        <div class="buff-bar" id="buffBar"></div>
        <div class="skill-bar" id="skillBar"></div>
        <div class="controls" id="controlsUI" style="display: none;">
            [â†â†’] ì´ë™ | [â†‘/Space] ì í”„ | [A] ê¸°ë³¸ê³µê²© | [Z][X][C] ìŠ¤í‚¬
        </div>
        <div class="level-up" id="levelUpText">LEVEL UP!</div>
        <div class="stat-gain" id="statGainText"></div>
    </div>

    <!-- Test Control Panel -->
    <div class="test-panel" id="testPanel">
        <h2>ğŸ§ª Integration Test Control</h2>

        <div>
            <button class="test-button" onclick="runQuickTest()">Quick Test (All Jobs)</button>
            <button class="test-button" onclick="runWarriorTest()">Test Warrior</button>
            <button class="test-button" onclick="runThiefTest()">Test Thief</button>
            <button class="test-button" onclick="runArcherTest()">Test Archer</button>
        </div>

        <div class="test-status" id="testStatus">
            <div>Status: <span class="status-running">Ready</span></div>
            <div>Tests Passed: <span id="passCount">0</span></div>
            <div>Tests Failed: <span id="failCount">0</span></div>
            <div>Pass Rate: <span id="passRate">0%</span></div>
        </div>

        <div class="test-log" id="testLog">
            <div>Console output will appear here...</div>
        </div>

        <button class="test-button" onclick="clearLog()" style="margin-top: 10px;">Clear Log</button>
        <button class="test-button" onclick="togglePanel()">Hide Panel</button>
    </div>

    <!-- Game Scripts -->
    <script type="module">
        // Import game modules
        import { game, player } from '../../src/state.js';
        import { JOBS } from '../../data/jobs.js';

        // Expose to global scope for testing
        window.__game = game;
        window.__player = player;
        window.__JOBS = JOBS;

        console.log('âœ… Game state exposed for testing');
    </script>

    <script type="module" src="../../src/main.js"></script>

    <!-- Test Script -->
    <script src="./integration-test.js"></script>

    <!-- Test UI Controls -->
    <script>
        // Intercept console.log for test panel
        const originalLog = console.log;
        const originalError = console.error;
        const testLog = document.getElementById('testLog');

        function addToLog(message, type = 'info') {
            const div = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            div.innerHTML = `<span style="color: #888">${timestamp}</span> ${message}`;
            if (type === 'error') div.style.color = '#ff4444';
            if (type === 'success') div.style.color = '#44ff66';
            if (type === 'warn') div.style.color = '#ffaa44';
            testLog.appendChild(div);
            testLog.scrollTop = testLog.scrollHeight;
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog(args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog(args.join(' '), 'error');
        };

        // Test runners
        async function runQuickTest() {
            addToLog('Starting quick test for all jobs...', 'info');
            updateStatus('running', 'Running tests...');

            for (const job of ['warrior', 'thief', 'archer']) {
                addToLog(`\n=== Testing ${job.toUpperCase()} ===`, 'info');
                const results = await runIntegrationTests(job);
                updateResults(results);

                if (job !== 'archer') {
                    addToLog('Reloading for next job...', 'info');
                    await new Promise(r => setTimeout(r, 1000));
                    location.reload();
                    await new Promise(r => setTimeout(r, 2000));
                }
            }

            updateStatus('complete', 'All tests complete!');
        }

        async function runWarriorTest() {
            await runSingleJobTest('warrior');
        }

        async function runThiefTest() {
            await runSingleJobTest('thief');
        }

        async function runArcherTest() {
            await runSingleJobTest('archer');
        }

        async function runSingleJobTest(job) {
            addToLog(`\nStarting integration test for ${job}...`, 'info');
            updateStatus('running', `Testing ${job}...`);

            const results = await runIntegrationTests(job);
            updateResults(results);
            updateStatus('complete', 'Test complete!');
        }

        function updateResults(results) {
            document.getElementById('passCount').textContent = results.passed.length;
            document.getElementById('failCount').textContent = results.failed.length;

            const total = results.passed.length + results.failed.length;
            const rate = total > 0 ? ((results.passed.length / total) * 100).toFixed(1) : 0;
            document.getElementById('passRate').textContent = rate + '%';
        }

        function updateStatus(status, message) {
            const statusEl = document.querySelector('#testStatus .status-running');
            statusEl.textContent = message;
            statusEl.className = status === 'running' ? 'status-running' :
                                status === 'complete' ? 'status-pass' : 'status-fail';
        }

        function clearLog() {
            testLog.innerHTML = '<div>Log cleared.</div>';
        }

        function togglePanel() {
            const panel = document.getElementById('testPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // Make functions global
        window.runQuickTest = runQuickTest;
        window.runWarriorTest = runWarriorTest;
        window.runThiefTest = runThiefTest;
        window.runArcherTest = runArcherTest;
        window.clearLog = clearLog;
        window.togglePanel = togglePanel;
    </script>
</body>
</html>
